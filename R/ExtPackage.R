#' Extension package class
#'
#' @description
#' A class for generating the skeleton of a new extension package.
#'
#' @details
#' This class manages the files of an extension package.
#'
#' It can generate all the files of a new extension package: DESCRIPTION,
#' NEWS, README.md, tests, definitons.yml, etc. Optionnaly it also generates
#' other files like: a `.travis.yml` file for Travis-CI, a Makefile for easing
#' development on UNIX-like platforms outside of Rstudio.
#'
#' It can also upgrade files of an existing package like: definitions.yml,
#' Makefile, .travis.yml, LICENSE, etc.
#'
#' @import R6
#' @import chk 
#' @export
ExtPackage <- R6::R6Class('ExtPackage',

public=list(
         
#' @description
#' Constructor
#' @param path     The path to the package folder.
#' @param dbName   The name of the database (in biodb format "my.db.name"),
#' that will be used in "definitions.yml" file and for connector and entry
#' classe.
#' @param makefile Set to TRUE if you want a Makefile to be generated.
#' add some special directives inside the Makefile.
#' @param rcpp     Set to TRUE to enable Rcpp C/C++ code inside the package.
#' @return A new instance.
initialize=function(path, dbName=NULL, newPkg=FALSE, makefile=FALSE,
                    rcpp=FALSE) {
    chk::chk_string(path)
    chk::chk_null_or(dbName, chk::chk_string)
    chk::chk_flag(newPkg)
    chk::chk_flag(makefile)
    chk::chk_flag(rcpp)
    
    private$path <- path
    private$dbName <- dbName
    private$newPkg <- newPkg
    private$makefile <- makefile
    private$rcpp <- rcpp
},

#' @description
#' Generates the skeleton for the new extension package.
#'
#' @examples
#' # Create a new package:
#' biodb::ExtPackage$new('/path/to/my/biodbMyNewDb')$generate()
#'
generate=function() {
    
    private$checkPathDoesNotExist()
    private$checkName()
    
    dir.create(private$getPath())
    ExtDescriptionFile$new(private$getPath(), dbName=private$dbName,
                           newPkg=private$newPkg, rcpp=private$rcpp)$generate()
    if (private$makefile)
        ExtMakefile$new(private$getPath(), newPkg=private$newPkg)$generate()
},

#' @description
#' Upgrade files of (definitions.yml, Makefile, etc) an existing extension
#' package.
#'
#' @examples
#' # Create a new package:
#' biodb::ExtPackage$new('/path/to/my/biodbFooDb')$upgrade()
#'
upgrade=function() {
    private$checkPathExists()
    private$checkName()
    private$checkFilesExist()
    if (private$makefile)
        ExtMakefile$new(private$getPath(), newPkg=private$newPkg)$upgrade()
}
),

private=list(
    path=NULL,
    dbName=NULL,
    newPkg=NULL,
    rcpp=NULL,
    makefile=NULL,

checkPathExists=function() {
    chk::chk_dir(private$path)
},

checkFilesExist=function() {
    chk::chk_file(file.path(private$getPath(), 'DESCRIPTION'))
    # NAMESPACE file will be generated by roxygen2.
},

checkPathDoesNotExist=function() {
    if (dir.exists(private$path))
        stop('A folder already exists at "', private$path, '".')
    if (file.exists(private$path))
        stop('A file already exists at "', private$path, '".')
},

getPath=function() {
    return(normalizePath(private$path, mustWork=FALSE))
},

getName=function() {
    return(basename(private$getPath()))
},

checkName=function() {
    chk::chk_match(private$getName(), regexp="^biodb[A-Z]")
}
))
