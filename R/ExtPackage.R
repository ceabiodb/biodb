#' A class for generating the skeleton of a new extension package.
#'
#' This class manages the files of an extension package.
#'
#' It can generate all the files of a new extension package: DESCRIPTION,
#' NEWS, README.md, tests, definitons.yml, etc. Optionnaly it also generates
#' other files like: a `.travis.yml` file for Travis-CI, a Makefile for easing
#' development on UNIX-like platforms outside of Rstudio.
#'
#' It can also upgrade files of an existing package like: definitions.yml,
#' Makefile, .travis.yml, LICENSE, etc.
#'
#' @param path     The path to the package folder.
#' @param dbName   The name of the database (in biodb format "my.db.name"),
#' that will be used in "definitions.yml" file and for connector and entry
#' classe.
#' @param makefile Set to TRUE if you want a Makefile to be generated.
#' add some special directives inside the Makefile.
#' @param rcpp     Set to TRUE to enable Rcpp C/C++ code inside the package.
#'
#' @examples
#' # Create a new package:
#' biodb::ExtPackage('biodbMyNewDb')$generate()
#'
#' @import methods
#' @import chk 
#' @export ExtPackage
#' @exportClass ExtPackage
ExtPackage <- methods::setRefClass('ExtPackage',
    fields=list(
        path='character',
        dbName='ANY',
        newPkg='logical',
        rcpp='logical',
        makefile='logical'
    ),

methods=list(
         
initialize=function(path, dbName=NULL, newPkg=FALSE, makefile=FALSE, rcpp=FALSE) {
    chk::chk_string(path)
    chk::chk_null_or(dbName, chk::chk_string)
    chk::chk_flag(newPkg)
    chk::chk_flag(makefile)
    chk::chk_flag(rcpp)
    
    .self$path <- path
    .self$dbName <- dbName
    .self$newPkg <- newPkg
    .self$makefile <- makefile
    .self$rcpp <- rcpp
},

checkPathExists=function() {
    chk::chk_dir(.self$path)
},

checkFilesExist=function() {
    chk::chk_file(file.path(.self$getPath(), 'DESCRIPTION'))
    # NAMESPACE file will be generated by roxygen2.
},

checkPathDoesNotExist=function() {
    if (dir.exists(.self$path))
        stop('A folder already exists at "', .self$path, '".')
    if (file.exists(.self$path))
        stop('A file already exists at "', .self$path, '".')
},

getPath=function() {
    return(normalizePath(.self$path, mustWork=FALSE))
},

getName=function() {
    return(basename(.self$getPath()))
},

checkName=function() {
    chk::chk_match(.self$getName(), regexp="^biodb[A-Z]")
},

generate=function() {
    ":\n\nGenerates the skeleton for the new extension package.
    \nReturned value: None.
    "
    
    .self$checkPathDoesNotExist()
    .self$checkName()
    
    dir.create(.self$getPath())
    ExtDescriptionFile(.self$getPath(), dbName=.self$dbName,
                       newPkg=.self$newPkg, rcpp=.self$rcpp)$generate()
    if (.self$makefile)
        ExtMakefile(.self$getPath(), newPkg=.self$newPkg)$generate()
},

upgrade=function() {
    ":\n\nUpgrading files (definitions.yml, Makefile, etc) of an existing
    extension package.
    \nReturned value: None.
    "
    
    .self$checkPathExists()
    .self$checkName()
    .self$checkFilesExist()
    if (.self$makefile)
        ExtMakefile(.self$getPath(), newPkg=.self$newPkg)$upgrade()
}
))
