---
title: "*biodb*: In-house LCMS database"
author: "Pierrick Roger"
date: "`r doc_date()`"
package: "`r pkg_ver('biodb')`"
abstract: |
  How to define an in-house LCMS database and run annotation using it.
vignette: |
  %\VignetteIndexEntry{In-house LCMS database}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
output:
  BiocStyle::html_document:
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: false
  BiocStyle::pdf_document: default
---

# Introduction

To load an in-house LCMS database, we are going to use the `mass.csv.file` database connector, which can be used for accessing an MS in-house database CSV file, an LCMS database CSV file, an MSMS database CSV file, or MSn, or a mix of all those different types.

We first create an instance of the `Biodb` class:
```{r}
mybiodb <- biodb::Biodb()
```

# Building an MS database from a data frame

For the example we will use a data.frame as input for the database connector, however the connector can directly read from a file too.

Here is the data frame:
```{r}
db.df <- rbind.data.frame(
           list(accession = "PR010001", smiles = "NCCCN",                      mass = 74.0844,   ms.mode = "pos", peak.mztheo = 73,  peak.intensity = 999, chrom.col.id = 'mycol', chrom.rt = 78, formula = "C3H10N2",  name = "1,3-Diaminopropane"                    ),
           list(accession = "PR010001", smiles = "NCCCN",                      mass = 74.0844,   ms.mode = "pos", peak.mztheo = 86,  peak.intensity = 407, chrom.col.id = 'mycol', chrom.rt = 78, formula = "C3H10N2",  name = "1,3-Diaminopropane"                    ),
           list(accession = "PR010001", smiles = "NCCCN",                      mass = 74.0844,   ms.mode = "pos", peak.mztheo = 174, peak.intensity = 481, chrom.col.id = 'mycol', chrom.rt = 78, formula = "C3H10N2",  name = "1,3-Diaminopropane"                    ),
           list(accession = "PR010002", smiles = "OCC(O)(C1)OCC(O)(CO)O1",     mass = 180.06339, ms.mode = "pos", peak.mztheo = 73,  peak.intensity = 999, chrom.col.id = 'mycol', chrom.rt = 189, formula = "C6H12O6",  name = "1,3-Dihydroxyacetone dimer"            ),
           list(accession = "PR010003", smiles = "OC(=O)CC(O)(CC(O)=O)C(O)=O", mass = 192.027,   ms.mode = "pos", peak.mztheo = 73,  peak.intensity = 999, chrom.col.id = 'mycol', chrom.rt = 45, formula = "C6H8O7",   name = "Citric acid"                           ),
           list(accession = "PR010004", smiles = "COc(c1)c(O)ccc(C=CC(O)=O)1", mass = 194.05791, ms.mode = "pos", peak.mztheo = 73,  peak.intensity = 999, chrom.col.id = 'mycol', chrom.rt = 90, formula = "C10H10O4", name = "trans-4-Hydroxy-3-methoxycinnamate"    ),
           list(accession = "PR010006", smiles = "CNC[C@H](O)c(c1)cc(O)cc1",   mass = 167.09463, ms.mode = "pos", peak.mztheo = 73,  peak.intensity = 751, chrom.col.id = 'mycol', chrom.rt = 176, formula = "C9H13NO2", name = "(R)-(-)-Phenylephrine"                 ),
           list(accession = "PR010006", smiles = "CNC[C@H](O)c(c1)cc(O)cc1",   mass = 167.09463, ms.mode = "pos", peak.mztheo = 116, peak.intensity = 999, chrom.col.id = 'mycol', chrom.rt = 176, formula = "C9H13NO2", name = "(R)-(-)-Phenylephrine"                 ),
           list(accession = "PR010007", smiles = "OC(=O)C(N)(C1)C1",           mass = 101.04768, ms.mode = "pos", peak.mztheo = 73,  peak.intensity = 999, chrom.col.id = 'mycol', chrom.rt = 120, formula = "C4H7NO2",  name = "1-Aminocyclopropane-1-carboxylic acid" ),
           list(accession = "PR010007", smiles = "OC(=O)C(N)(C1)C1",           mass = 101.04768, ms.mode = "pos", peak.mztheo = 147, peak.intensity = 533, chrom.col.id = 'mycol', chrom.rt = 120, formula = "C4H7NO2",  name = "1-Aminocyclopropane-1-carboxylic acid" ),
           list(accession = "PR010008", smiles = "OC(=O)Cc(c1)ccc(O)c1",       mass = 152.04734, ms.mode = "pos", peak.mztheo = 73,  peak.intensity = 999, chrom.col.id = 'mycol', chrom.rt = 156, formula = "C8H8O3",   name = "4-Hydroxyphenylacetic acid"            )
         , stringsAsFactors = FALSE)
```
Part of those data were extracted from MassBank.

We create the connector from the data frame, and will use this connector for all subsequent examples.
```{r}
conn <- mybiodb$getFactory()$createConn('mass.csv.file')
conn$setDb(db.df)
```

We define some missing fields (MS level and RT unit):
```{r}
conn$addField('ms.level', 1)
conn$addField('chrom.rt.unit', 's')
```

# Searching for entries

Searching by M/Z:
```{r}
conn$searchMsEntries(mz.min = 145.96, mz.max = 147.13)
```

Searching with multiple M/Z:
```{r}
conn$searchMsEntries(mz = c(86.000002, 146.999997), mz.tol = 10, mz.tol.unit = 'ppm')
```

Searching by M/Z and RT:
```{r}
conn$searchMsEntries(mz.min = 72.78, mz.max = 73.12, rt = 45.5, rt.tol = 1, rt.unit = 's')
```

Other parameters can be used in `searchMsEntries()`:

 * MS level.
 * MS mode.
 * Minimum of relative intensity.
 * Matching of precursor peak.
 * Maximum of results.

# Peak annotation

Peak annotation can be done with `searchMsPeaks()` method.

We must first define the data frame of inputs:
```{r}
input <- data.frame(mz=c(73.01, 116.04, 174.2),
                    rt=c(79, 173, 79))
```

Then we run the annotation:
```{r}
conn$searchMsPeaks(input, mz.tol=0.1, rt.unit='s', rt.tol=10, match.rt=TRUE, prefix='match.')
```

# Closing biodb instance

Do not forget to terminate your biodb instance once you are done with it:
```{r}
mybiodb$terminate()
```
