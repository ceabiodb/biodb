---
title: "*biodb*: MS annotation"
author: "Pierrick Roger"
date: "`r BiocStyle::doc_date()`"
package: "`r BiocStyle::pkg_ver('biodb')`"
abstract: |
  How to annotate a list of M/Z values with chemical and MS databases.
vignette: |
  %\VignetteIndexEntry{Annotation of M/Z values.}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
output:
  BiocStyle::html_document:
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: false
  BiocStyle::pdf_document: default
---

# Introduction

With biodb, it is possible to annotate M/Z values using chemical databases and LCMS databases.
We will see the both methods in this vignette.

We first create an instance of the `Biodb` class:
```{r Creation of the biodb instance}
mybiodb <- biodb::Biodb()
```

Here is the input data frame we want to annotate with both M/Z values and RT values in seconds:
```{r Set a list of M/Z values}
ms.tsv <- system.file("extdata", "ms.tsv", package='biodb')
mzdf <- read.table(ms.tsv, sep="\t")
```

# Annotation using a chemical database

We will use an extract from the ChEBI database for this example:
```{r}
chebi.tsv <- system.file("extdata", "chebi_extract.tsv", package='biodb')
chebi <- mybiodb$getFactory()$createConn('comp.csv.file', url=chebi.tsv)
```

Annotation is done using the `annotateMzValues()` method, which is a general method. It is thus available for all compound databases that allow search on masses.

Each database may allow search on some mass fields and forbid it on others. To check if a database allows search on a specific mass field, use the `isSearchableByField()` method:
```{r Check if a database is searchable by a mass field}
chebi$isSearchableByField('monoisotopic.mass')
```

To get a full list of possible mass fields, make the following call:
```{r}
mybiodb$getEntryFields()$getFieldNames('mass')
```

Now run the annotation:
```{r Annotate}
chebi$annotateMzValues(mzdf, mz.tol=1e-3, ms.mode='neg', fields=c('chebi.id', 'name', 'formula', 'molecular.mass', 'monoisotopic.mass'), fieldsLimit=1)
```
Note the use of the following parameters:
 * `fieldsLimit`: Used to limit the number of values output for fields. Here it is used for the `'name'` field, which may content more than one name for each entry. By setting the parameter to `1` we select only the first name for each ChEBI entry.
 * `fields`: Used to select the entry fields to output. If unset, all fields will be output.

For more details on the `annotateMzValues()` method, please this the help page of `BiodbCompounddbConn`.

# Annotation using an LCMS database

Annotation is also possible using an LCMS database.

For this example we use an in-house database saved as a TSV file:
```{r Instantiate an in-house LCMS database}
lcmsdb <- system.file("extdata", "massbank_extract.tsv", package="biodb")
massbank <- mybiodb$getFactory()$createConn('mass.csv.file', url=lcmsdb)
```
The database file was built using Massbank data. The accession numbers correspond to real Massbank entries.

Now that the database is loaded, we define some missing fields (MS level and RT unit):
```{r Set missing fields on database}
massbank$addField('ms.level', 1)
massbank$addField('chrom.rt.unit', 's')
```

We will now annotate our M/Z peaks, selecting a set of fields from the database to write in the output data frame:
```{r Annotate M/Z values with an in-house LCMS database}
massbank$searchMsPeaks(mzdf, mz.tol=1e-3, fields=c('accession', 'name', 'formula', 'chebi.id'), prefix='mydb.')
```

Annotation is also possible using retention times.
We then choose the chromatographic columns on which we want to match, and the set of fields we want in output:
```{r Set chromatographic columns and output fields}
chromColIds <- c('TOSOH TSKgel ODS-100V  5um Part no. 21456')
fields <- c('accession', 'name', 'formula', 'chebi.id', 'chrom.rt', 'chrom.col.id')
```

Finally we run the annotation on M/Z and RT values:
```{r Annotate using RT values}
massbank$searchMsPeaks(mzdf, mz.tol=1e-3, fields=fields, prefix='mydb.', chrom.col.ids=chromColIds, rt.unit='s', rt.tol=10, match.rt=TRUE)
```

For more details on the `searchMsPeaks()` method, please this the help page of `BiodbMassdbConn`.

# Closing biodb instance

Do not forget to terminate your biodb instance once you are done with it:
```{r Closing of the biodb instance}
mybiodb$terminate()
```
