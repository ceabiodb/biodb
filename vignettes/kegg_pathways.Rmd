---
title: "Detected related compounds using KEGG databases"
author: "Pierrick Roger"
output:
  html_document:
    theme: null
package: biodb
abstract: |
  This vignette shows how to check if it exists a functional link between compounds, in pathways, using KEGG databases.
vignette: |
  %\VignetteIndexEntry{Accessing KEGG databases}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Introduction

In this vignette, we will:
 * Look for pathways related to specified compounds.
 * Count to how many pathways each compound is related.
 * Build a pathway graph.
 * Create a decorated pathway graph picture.

For that we will start from a given list of KEGG compound IDs, and explore KEGG to find to which organisms they can be related and try to discover links between them through KEGG pathways.

As an example, we will start for a predefined list of KEGG compound IDs, and focus on one organism, the mouse.

# Initializing the library

First we need to create an instance of the `Biodb` class:
```{r Initializing Biodb}
mybiodb = biodb::Biodb()
```

# Creating a connector

We need a connector to the KEGG Compound database:
```{r}
kegg.comp.conn = mybiodb$getFactory()$getConn('kegg.compound')
```

# List of compound IDs

We will use the following list of compounds as a start in our search:
```{r}
kegg.comp.ids = c('C02648', 'C06144', 'C06178', 'C02659', 'C02659',
                  'C01746', 'C01746', 'C00741', 'C01770', 'C01771',
                  'C02497', 'C16267', 'C00741', 'C01770', 'C01771',
                  'C02497', 'C16267', 'C02640', 'C00134', 'C00041',
                  'C00099', 'C00133', 'C00213', 'C01401', 'C01537',
                  'C02116', 'C11488', 'C07090', 'C14279', 'C00414',
                  'C02019', 'C08497', 'C16310', 'C11118', 'C02240')
```

# Look for pathways related to specified compounds

Given a list of compounds and an organism, we can look for pathways in a single command:
```{r}
pathways = kegg.comp.conn$getPathwayIds(kegg.comp.ids, 'mmu')
pathways
```

# Count to how many pathways each compound is related

With another function we can get the pathways found for each compound:
```{r}
path.per.comp = kegg.comp.conn$getPathwayIdsPerCompound(kegg.comp.ids, 'mmu')
nb_mmu_gene_pathways = vapply(kegg.comp.ids, function(i) if (i %in% names(path.per.comp)) length(path.per.comp[[i]]) else 0, FUN.VALUE = 0)
names(nb_mmu_gene_pathways) = kegg.comp.ids
```

Here, in the final table, we list the number of pathways for each KEGG compound:
```{r}
nb_mmu_gene_pathways
```

# Build a pathway graph

To build a pathway graph, we need a connector to the KEGG Pathway database:
```{r Getting a connector to the KEGG Pathway database}
kegg.path.conn = mybiodb$getFactory()$getConn('kegg.pathway')
```

Now we build the graph for the first pathway found:
```{r Building a pathway graph}
graph = kegg.path.conn$buildPathwayGraph('mmu00260')
```

<!-- TODO Use DiagrammeR to plot with GrapheVIZ instead (see http://rich-iannone.github.io/DiagrammeR/graphs.html). -->
And we plot it:
```{r Plotting the pathway graph}
plot(graph, layout = igraph::layout_with_kk)
```

# Create a decorated pathway graph picture

We will now use a KEGG pathway picture and highlight some of the enzymes and compounds on it.

For this, we first define the colors we want to apply:
```{r Attributing colors to entries}
c = list(yellow = c('4.2.1.22', '4.2.3.1', '3.5.4.44', '2.7.2.4',
                    '1.2.1.8', '4.1.2.48'),
         green = c('C00101', 'C00168', 'C01026', 'C00581', 'C00014',
                   'C05519'))
```

Then we call the method:
```{r Creating a decorated pathway picture}
img = kegg.path.conn$getDecoratedGraphPicture('mmu00260', color2ids = c)
```

And print the image:
```{r}
print(img)
```

# Terminate the biodb instance

Once we are done with Biodb, we need to terminate properly the `Biodb` instance:
```{r Terminating the Biodb instance}
mybiodb$terminate()
```
