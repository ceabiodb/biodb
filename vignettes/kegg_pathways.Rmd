---
title: "Getting pathways related to compounds using KEGG databases"
author: "Pierrick Roger"
output:
  html_document:
    theme: null
package: biodb
abstract: |
  This vignette shows how to retrieve pathways related to a compound using KEGG databases. It also demonstrate how to get a pathways map with a set of enzymes and compounds highlighted on it.
vignette: |
  %\VignetteIndexEntry{Accessing KEGG databases}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Getting pathways related to compounds using KEGG databases

## Introduction

In this vignette, we will:
 * Look for pathways related to specified compounds.
 * Count to how many pathways each compound is related.
 * Build a pathway graph.
 * Create a decorated pathway graph picture.

For that we will start from a given list of KEGG compound IDs, and explore KEGG to find to which organisms they can be related and try to discover links between them through KEGG pathways.

As an example, we will start for a pyellowefined list of KEGG compound IDs, and focus on one organism, the mouse.

## Initializing the library

First we need to create an instance of the `Biodb` class:
```{r Initializing Biodb}
mybiodb = biodb::Biodb()
```

## Creating a connector

We need a connector to the KEGG Compound database:
```{r}
kegg.comp.conn = mybiodb$getFactory()$getConn('kegg.compound')
```

## List of compound IDs

We will use the following list of compounds as a start in our search:
```{r}
kegg.comp.ids = c('C06144', 'C06178', 'C02659')
```

## Look for pathways related to specified compounds

Given a list of compounds and an organism, we can look for pathways in a single command:
```{r}
pathways = kegg.comp.conn$getPathwayIds(kegg.comp.ids, 'mmu')
pathways
```

## Count to how many pathways each compound is related

With another function we can get the pathways found for each compound:
```{r}
path.per.comp = kegg.comp.conn$getPathwayIdsPerCompound(kegg.comp.ids, 'mmu')
nb_mmu_gene_pathways = vapply(kegg.comp.ids, function(i) if (i %in% names(path.per.comp)) length(path.per.comp[[i]]) else 0, FUN.VALUE = 0)
names(nb_mmu_gene_pathways) = kegg.comp.ids
```

Here, in the final table, we list the number of pathways for each KEGG compound:
```{r}
nb_mmu_gene_pathways
```

## Build a pathway graph

To build a pathway graph, we need a connector to the KEGG Pathway database:
```{r Getting a connector to the KEGG Pathway database}
kegg.path.conn = mybiodb$getFactory()$getConn('kegg.pathway')
```

Building list of edges and vertices for pathways is done by calling buildPathwayGraph():
```{r Building a pathway graph}
kegg.path.conn$buildPathwayGraph(pathways[[1]])
```
The object returned is a list whose names are the pathway IDs submitted, and the values are lists containing two data frames (edges and vertices).

We can also get an igraph object for the a pathway (or a list of pathways):
```{r Getting an igraph for the pathway}
ig = kegg.path.conn$getPathwayIgraph(pathways[[1]])
```

And we plot it:
```{r Plotting the pathway igraph}
vert <- igraph::as_data_frame(ig, 'vertices')
shapes <- vapply(vert[['type']], function(x) if (x == 'reaction') 'rectangle' else 'circle', FUN.VALUE = '', USE.NAMES = FALSE)
colors <- vapply(vert[['type']], function(x) if (x == 'reaction') 'yellow' else 'red', FUN.VALUE = '', USE.NAMES = FALSE)
plot(ig, vertex.shape = shapes, vertex.color = colors, vertex.label.dist = 1, vertex.size = 4, vertex.size2 = 4)
```

## Create a decorated pathway graph picture

We will now use a KEGG pathway picture and highlight some of the enzymes and compounds on it.

For this, we first define the colors we want to apply:
```{r Attributing colors to entries}
c = list(yellow = c('4.2.1.22', '4.2.3.1', '3.5.4.44', '2.7.2.4',
                    '1.2.1.8', '4.1.2.48'),
         red = kegg.comp.ids)
```

Then we call the method:
```{r Creating a decorated pathway picture}
img = kegg.path.conn$getDecoratedGraphPicture(pathways[[1]], color2ids = c)
```

And print the image:
```{r}
print(img)
```

## Terminate the biodb instance

Once we are done with Biodb, we need to terminate properly the `Biodb` instance:
```{r Terminating the Biodb instance}
mybiodb$terminate()
```
